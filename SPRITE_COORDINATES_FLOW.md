# ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚·ãƒ¼ãƒˆåº§æ¨™ã®æµã‚Œ - å®Œå…¨ã‚¬ã‚¤ãƒ‰

## ğŸ¯ æ¦‚è¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚·ãƒ¼ãƒˆç”Ÿæˆã‹ã‚‰æŠ½å‡ºã¾ã§ã®åº§æ¨™ã®æµã‚Œã‚’èª¬æ˜ã—ã¾ã™ã€‚
**ã‚ªãƒªã‚¸ãƒŠãƒ«ã®ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆé ˜åŸŸãŒæ­£ã—ããƒ”ãƒƒã‚¯ã•ã‚Œã‚‹ã“ã¨ã‚’ä¿è¨¼**ã—ã¦ã„ã¾ã™ã€‚

## ğŸ“ åº§æ¨™ã‚·ã‚¹ãƒ†ãƒ 

### åº§æ¨™ã®ç¨®é¡

1. **Cell åº§æ¨™** - ã‚»ãƒ«å…¨ä½“ï¼ˆãƒ‘ãƒ‡ã‚£ãƒ³ã‚° + ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆ + ãƒ©ãƒ™ãƒ«é ˜åŸŸï¼‰
2. **Content åº§æ¨™** - å®Ÿéš›ã®ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆç”»åƒã®é ˜åŸŸï¼ˆã“ã‚ŒãŒé‡è¦ï¼ï¼‰
3. **Guideline åº§æ¨™** - æ ç·šã®æç”»ä½ç½®ï¼ˆã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã¨é‡ãªã‚‰ãªã„ï¼‰

### åº§æ¨™ã®é–¢ä¿‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cell (x, y)                             â”‚  â† ã‚»ãƒ«å…¨ä½“
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Guideline Outer (offset +3px)     â”‚  â”‚  â† å¤–å´æ ç·š
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Guideline Inner (offset-3px)â”‚  â”‚  â”‚  â† å†…å´æ ç·š
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ Content (x, y)         â”‚â”‚  â”‚  â”‚  â† ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆç”»åƒ
â”‚  â”‚  â”‚  â”‚                         â”‚â”‚  â”‚  â”‚    (ã“ã“ãŒæŠ½å‡ºå¯¾è±¡ï¼)
â”‚  â”‚  â”‚  â”‚   [Sprite Image]        â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚                         â”‚â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           [Sprite Name Label]           â”‚  â† ãƒ©ãƒ™ãƒ«é ˜åŸŸ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é‡è¦**:
- **ç”»åƒé…ç½®**: `Content (x, y)` ã«é…ç½®
- **ä¿å­˜**: `Content (x, y, width, height)` ã‚’ Layout ã¨ã—ã¦ä¿å­˜
- **æŠ½å‡º**: ä¿å­˜ã•ã‚ŒãŸ `Content` åº§æ¨™ã‹ã‚‰æŠ½å‡º
- **æ ç·š**: `Content` ã®å¤–å´ï¼ˆÂ±3pxï¼‰ã«æç”»

## ğŸ”„ åº§æ¨™ã®æµã‚Œ

### ã‚¹ãƒ†ãƒƒãƒ— 1: ãƒ‘ãƒƒã‚­ãƒ³ã‚° (`sprite-packer.ts`)

```typescript
// 1. ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’ãƒ‘ãƒƒã‚­ãƒ³ã‚°
const packResult = packTextures(textureData);

// 2. å„ãƒ†ã‚¯ã‚¹ãƒãƒ£ã®åº§æ¨™ã‚’è¨ˆç®—
for (const texture of textures) {
  // ã‚»ãƒ«ã®ä½ç½®ã‚’æ±ºå®š
  const placementX = 0;  // ä¾‹
  const placementY = 0;

  // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’è¨ˆç®—
  const layout = calculateSpriteLayout(
    texture.name,
    placementX,      // ã‚»ãƒ«ã®Xåº§æ¨™
    placementY,      // ã‚»ãƒ«ã®Yåº§æ¨™
    texture.width,   // å®Ÿéš›ã®ç”»åƒå¹…
    texture.height   // å®Ÿéš›ã®ç”»åƒé«˜ã•
  );

  // çµæœ:
  // - layout.cell.x, .y        : ã‚»ãƒ«å…¨ä½“ã®ä½ç½®
  // - layout.content.x, .y     : ç”»åƒé…ç½®ä½ç½® (cell + PADDING)
  // - layout.content.width, .height : ç”»åƒã‚µã‚¤ã‚º
  // - layout.guidelines.inner  : å†…å´æ ç·š (content - OFFSET)
  // - layout.guidelines.outer  : å¤–å´æ ç·š (cell + OFFSET)
}
```

**åº§æ¨™è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯** (`sprite-coordinates.ts`):
```typescript
const PADDING = 12;           // ã‚»ãƒ«å¢ƒç•Œã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¾ã§
const GUIDELINE_OFFSET = 3;   // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‹ã‚‰æ ç·šã¾ã§

// ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä½ç½® = ã‚»ãƒ«ä½ç½® + ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°
contentX = cellX + PADDING;    // ä¾‹: 0 + 12 = 12
contentY = cellY + PADDING;    // ä¾‹: 0 + 12 = 12

// å†…å´æ ç·š = ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä½ç½® - ã‚ªãƒ•ã‚»ãƒƒãƒˆ
guidelineInner.x = contentX - GUIDELINE_OFFSET;  // ä¾‹: 12 - 3 = 9
guidelineInner.y = contentY - GUIDELINE_OFFSET;  // ä¾‹: 12 - 3 = 9
```

### ã‚¹ãƒ†ãƒƒãƒ— 2: ç”»åƒé…ç½® (`texture-group-manager.ts:generateSpriteSheet`)

```typescript
// 1. ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚·ãƒ¼ãƒˆã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œæˆ
const canvas = sharp({ create: { width, height, channels: 4 } });

// 2. å„ç”»åƒã‚’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä½ç½®ã«é…ç½®
const composites = packResult.textures.map(texture => {
  return {
    input: texture.imageData,
    left: texture.contentX,    // â† Content Xåº§æ¨™ã‚’ä½¿ç”¨
    top: texture.contentY,     // â† Content Yåº§æ¨™ã‚’ä½¿ç”¨
  };
});

// 3. åˆæˆ
await canvas.composite(composites).png().toBuffer();

// ãƒ­ã‚°å‡ºåŠ›ä¾‹:
// [Sprite Placement] PLAYA1: Cell(0, 0, 76x128) Content(12, 12, 52x92)
```

### ã‚¹ãƒ†ãƒƒãƒ— 3: ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¿å­˜

```typescript
// Contentåº§æ¨™ã‚’Layoutã¨ã—ã¦ä¿å­˜
const layout: TextureLayout[] = packResult.textures.map(t => ({
  textureName: t.name,
  x: t.contentX,        // â† Content Xåº§æ¨™ã‚’ä¿å­˜
  y: t.contentY,        // â† Content Yåº§æ¨™ã‚’ä¿å­˜
  width: t.contentWidth,   // â† å®Ÿéš›ã®ç”»åƒå¹…
  height: t.contentHeight, // â† å®Ÿéš›ã®ç”»åƒé«˜ã•
}));

// ãƒ­ã‚°å‡ºåŠ›ä¾‹:
// [Layout Saved] PLAYA1: Extract from (12, 12, 52x92)
```

### ã‚¹ãƒ†ãƒƒãƒ— 4: æ ç·šæç”» (`addGridGuidelines`)

```typescript
// æ ç·šã¯ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã¨é‡ãªã‚‰ãªã„ä½ç½®ã«æç”»
for (const texture of textures) {
  const { guidelines } = texture.layout;

  // å¤–å´æ ç·š (lime, ç‚¹ç·š)
  drawRect(guidelines.outer.x, guidelines.outer.y, ...);

  // å†…å´æ ç·š (cyan, å®Ÿç·š) - ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å¤–å´
  drawRect(guidelines.inner.x, guidelines.inner.y, ...);

  // inner.x = contentX - 3
  // inner.y = contentY - 3
  // â†’ ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã«ã¯é‡ãªã‚‰ãªã„ï¼
}
```

### ã‚¹ãƒ†ãƒƒãƒ— 5: æŠ½å‡º (`extractTexturesFromSpriteSheet`)

```typescript
// ä¿å­˜ã•ã‚ŒãŸLayoutåº§æ¨™ã‚’ä½¿ç”¨ã—ã¦æŠ½å‡º
for (const layout of group.layout) {
  const extracted = await sharp(spriteSheetBuffer)
    .extract({
      left: layout.x,      // â† ä¿å­˜ã•ã‚ŒãŸContent X
      top: layout.y,       // â† ä¿å­˜ã•ã‚ŒãŸContent Y
      width: layout.width,   // â† ä¿å­˜ã•ã‚ŒãŸç”»åƒå¹…
      height: layout.height, // â† ä¿å­˜ã•ã‚ŒãŸç”»åƒé«˜ã•
    });

  // ãƒ­ã‚°å‡ºåŠ›ä¾‹:
  // [Extracting] PLAYA1: from (12, 12, 52x92)
}
```

## âœ… æ•´åˆæ€§ã®ä¿è¨¼

### è‡ªå‹•æ¤œè¨¼

ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚·ãƒ¼ãƒˆç”Ÿæˆæ™‚ã«è‡ªå‹•çš„ã«ä»¥ä¸‹ã‚’æ¤œè¨¼ã—ã¾ã™ï¼š

1. **ãƒ‘ãƒƒã‚­ãƒ³ã‚°æ¤œè¨¼** (`validatePackedTextures`)
   - Content ãŒCellå†…ã«ã‚ã‚‹ã‹
   - Content ãŒã‚­ãƒ£ãƒ³ãƒã‚¹å†…ã«ã‚ã‚‹ã‹
   - æ ç·šãŒã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã¨é‡ãªã‚‰ãªã„ã‹

2. **ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ•´åˆæ€§æ¤œè¨¼** (`validateLayoutConsistency`)
   - ä¿å­˜ã•ã‚ŒãŸLayoutåº§æ¨™ = PackedTextureã®Contentåº§æ¨™
   - å…¨ã¦ã®ãƒ†ã‚¯ã‚¹ãƒãƒ£ãŒLayoutã«å«ã¾ã‚Œã‚‹ã‹

### æ¤œè¨¼ãƒ­ã‚°å‡ºåŠ›

```
ğŸ” Validating packed texture coordinates...
=== Sprite Layout Validation Report ===
Status: âœ… VALID

ğŸ“Š COORDINATE DETAILS:

  PLAYA1:
    Cell:       (0, 0) 76x128
    Content:    (12, 12) 52x92
    Extraction: (12, 12) 52x92
    Guidelines:
      Outer: (3, 3) 70x122
      Inner: (9, 9) 58x98

ğŸ” Validating layout consistency...
=== Sprite Layout Validation Report ===
Status: âœ… VALID

âœ… All validations passed! Sprite coordinates are consistent.
```

## ğŸ¨ å…·ä½“ä¾‹

### ä¾‹: 52x92 ã®ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆ

```
PADDING = 12
GUIDELINE_OFFSET = 3
LABEL_HEIGHT = 20
GAP = 8

Cell:
  x = 0
  y = 0
  width = 52 + 12*2 = 76
  height = 92 + 12*2 + 20 = 136

Content (ç”»åƒé…ç½®ä½ç½®):
  x = 0 + 12 = 12
  y = 0 + 12 = 12
  width = 52
  height = 92

Guideline Inner (å†…å´æ ç·š):
  x = 12 - 3 = 9
  y = 12 - 3 = 9
  width = 52 + 3*2 = 58
  height = 92 + 3*2 = 98

Guideline Outer (å¤–å´æ ç·š):
  x = 0 + 3 = 3
  y = 0 + 3 = 3
  width = 76 - 3*2 = 70
  height = 136 - 3*2 = 130
```

**çµæœ**:
- ç”»åƒã¯ (12, 12) ã«é…ç½®ã•ã‚Œã‚‹
- Layout ã« (12, 12, 52, 92) ãŒä¿å­˜ã•ã‚Œã‚‹
- æŠ½å‡ºæ™‚ã« (12, 12, 52, 92) ã‹ã‚‰åˆ‡ã‚Šå–ã‚‰ã‚Œã‚‹
- æ ç·šã¯ (9, 9) ã‹ã‚‰å§‹ã¾ã‚Šã€ç”»åƒã«é‡ãªã‚‰ãªã„

## ğŸ” ãƒ‡ãƒãƒƒã‚°æ–¹æ³•

### 1. ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’ç¢ºèª

ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚·ãƒ¼ãƒˆç”Ÿæˆæ™‚ã«ä»¥ä¸‹ã®ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ï¼š

```
[Sprite Placement] <åå‰>: Cell(...) Content(...)
[Layout Saved] <åå‰>: Extract from (...)
```

æŠ½å‡ºæ™‚ã«ï¼š

```
[Extracting] <åå‰>: from (...)
```

### 2. åº§æ¨™ãŒä¸€è‡´ã™ã‚‹ã‹ç¢ºèª

- `[Sprite Placement]` ã® `Content` åº§æ¨™
- `[Layout Saved]` ã®åº§æ¨™
- `[Extracting]` ã®åº§æ¨™

ã“ã‚Œã‚‰ãŒå…¨ã¦åŒã˜ã§ã‚ã‚Œã°æ­£ã—ãå‹•ä½œã—ã¦ã„ã¾ã™ã€‚

### 3. æ¤œè¨¼ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèª

`Status: âœ… VALID` ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

## ğŸš€ ã¾ã¨ã‚

**åº§æ¨™ã®æµã‚Œ**:
1. ãƒ‘ãƒƒã‚­ãƒ³ã‚° â†’ Contentåº§æ¨™ã‚’è¨ˆç®—
2. é…ç½® â†’ Contentåº§æ¨™ã«ç”»åƒã‚’é…ç½®
3. ä¿å­˜ â†’ Contentåº§æ¨™ã‚’Layoutã¨ã—ã¦ä¿å­˜
4. æ ç·š â†’ Contentåº§æ¨™ã‹ã‚‰Â±3pxã®ä½ç½®ã«æç”»ï¼ˆé‡ãªã‚‰ãªã„ï¼‰
5. æŠ½å‡º â†’ ä¿å­˜ã•ã‚ŒãŸContentåº§æ¨™ã‹ã‚‰æŠ½å‡º

**ä¿è¨¼**:
- âœ… é…ç½®åº§æ¨™ = ä¿å­˜åº§æ¨™ = æŠ½å‡ºåº§æ¨™
- âœ… æ ç·šã¯ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã¨é‡ãªã‚‰ãªã„ï¼ˆÂ±3px ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼‰
- âœ… è‡ªå‹•æ¤œè¨¼ã«ã‚ˆã‚Šæ•´åˆæ€§ã‚’ä¿è¨¼

**ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ**:
- `sprite-coordinates.ts` - åº§æ¨™è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
- `sprite-packer.ts` - ãƒ‘ãƒƒã‚­ãƒ³ã‚°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
- `sprite-layout-validator.ts` - æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯
- `texture-group-manager.ts` - ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚·ãƒ¼ãƒˆç”Ÿæˆãƒ»æŠ½å‡º

ã“ã‚Œã«ã‚ˆã‚Šã€**ã‚ªãƒªã‚¸ãƒŠãƒ«ã®ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆé ˜åŸŸãŒç¢ºå®Ÿã«ãƒ”ãƒƒã‚¯ã•ã‚Œã‚‹**ã“ã¨ãŒä¿è¨¼ã•ã‚Œã¾ã™ï¼
